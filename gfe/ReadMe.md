# Go File Events
(микро-сервис)

### Содержимое  
<a id="contents_list" name="contents_list"></a>
[1. Краткое описание сервиса](#section_1).  
[2. Подробное описание сервиса](#section_2).  
[3. Настройки сервиса](#section_3).  
[4. HTTP запросы](#section_4).  

## 1. Краткое описание сервиса
<a id="section_1" name="section_1"></a>

Микро-сервис 'Go File Events' производит два основных действия:  
1. читает из Kafka сообщения о событиях, связанных с файлами, и сохраняет информацию об этих событиях в базу данных;  
2. принимает HTTP запросы, на основании которых выдаёт из базы данных информацию о событиях, связанных с файлами.

[Вернуться назад ко списку содержимого](#contents_list)

## 2. Подробное описание сервиса
<a id="section_2" name="section_2"></a>

### 2.1. Отказоустойчивость

Сервис умеет плавно завершать свою работу. Для сигнализации завершения операционная система посылает сервису сигнал. 
В качестве сигнала завершения выступает стандартный кросс-платформенный (доступный на всех поддерживаемых О.С.) 
сигнал os.Interrupt (в О.С. семейства Linux ему соответствует SIGINT).  

Сервис в фоновом режиме переустанавливает подключения к Kafka и к базе данных в случае их разрыва.  

Поскольку метрики сервиса и его само-диагностика напрямую завязаны на HTTP сервер, ошибка (падение) HTTP сервера 
считается фатальной ошибкой, в её случае сервис (приложение) завершается.  

Количество ошибок отражено в соответствующих метриках сервиса. У важных метрик есть описание.  

Ошибки чтения сообщений Kafka являются критичными в силу особенностей работы самой Kafka. В случае подобных ошибок 
сервис на небольшой промежуток времени приостанавливает чтение сообщений из Kafka и пытается прочитать сообщение 
заново.  

### 2.2. Проверка входящих HTTP запросов

Для обработчиков (хендлеров) основных рабочих HTTP запросов сервис использует проверку клиента (аутентификацию, 
авторизацию) с помощью JWT токенов. Действительность JWT токена подтверждается проверкой подписи токена, для которой 
используется публичный RSA ключ, и конечно же проверками на время действия токена (поля 'EXP' и 'NBF'). Публичный 
RSA ключ для проверки подписи токена можно задавать несколькими способами: передавать через переменную окружения, 
через файл, через хранилище Vault. При передаче ключа через переменную окружения важно заэкранировать символы 
переноса строки с помощью специального символа.  

### 2.3. Метрики и самоконтроль

Сервис использует и хранит метрики, работающие на основе Prometheus.  
Метрики доступны по HTTP запросу.
Подробности можно посмотреть в [соответствующем разделе](#section_4).  

Сервис отдаёт свой статус (состояние) по двум HTTP запросам, каждый из которых 
отвечает статус кодом 'OK' (200), если всё хорошо. 
Первый запрос проверяет доступность HTTP сервера сервиса. 
Второй запрос запускает внутреннюю само-диагностику. 
Само-диагностика проверяет доступность Kafka и базы данных. 
В случае ошибки, первая из ошибок попадает в ответ.
Подробности можно посмотреть в [соответствующем разделе](#section_4).

[Вернуться назад ко списку содержимого](#contents_list)

## 3. Настройки сервиса
<a id="section_3" name="section_3"></a>

Сервис имеет настройку через переменные окружения.  

### 3.1. Переменные окружения
<br>

#### 3.1.1. GFE_IS_DEBUG_ENABLED
**Смысл**: Включатель режима отладки  
**Тип**: Булев  
**Значение по умолчанию**: false  
**Пример**: true  
<br>

#### 3.1.2. GFE_JWT_KEY_SOURCE_TYPE
**Смысл**: Тип источника публичного ключа для проверки JWT токенов  
**Тип**: Целочисленный  
**Значение по умолчанию**: отсутствует  
**Пример**: 1  
**Примечание**: 1 -- переменная окружения, 2 -- файл, 3 -- хранилище Vault.  
<br>

#### 3.1.3. GFE_JWT_KEY_DSN
**Смысл**: Data Source Name (спецификация пути) публичного ключа для проверки JWT токенов  
**Тип**: Текстовое значение    
**Значение по умолчанию**: отсутствует  
**Пример**: file://./keys/key-one.pub  
**Примечание**: файлы используют DSN в формате `file://path-to-file`  
<br>

#### 3.1.4. GFE_JWT_KEY_VALUE
**Смысл**: значение публичного ключа для проверки JWT токенов  
**Тип**: Текстовое значение    
**Значение по умолчанию**: отсутствует  
**Примечание**: используется только для типа 1 (переменная окружения);
для передачи символов переноса строки (CR, LF) используется точка ('.').
<br>

#### 3.1.5. GFE_KAFKA_CONSUMER_GROUP_ID
**Смысл**: Идентификатор группы потребителя Kafka  
**Тип**: Текстовое значение  
**Значение по умолчанию**: отсутствует  
**Пример**: super_consumer  
<br>

#### 3.1.6. GFE_KAFKA_BROKER_ADDRESS_LIST
**Смысл**: Список адресов посредников (брокеров) Kafka  
**Тип**: Массив из текстовых значений, разделённых запятой  
**Значение по умолчанию**: отсутствует  
**Пример**: 127.0.0.1:9092,127.0.0.1:9093  
<br>

#### 3.1.7. GFE_KAFKA_TOPIC_LIST
**Смысл**: Список тем (топиков) Kafka  
**Тип**: Массив из текстовых значений, разделённых запятой  
**Значение по умолчанию**: отсутствует  
**Пример**: super_topic_a,super_topic_b  
<br>

#### 3.1.8. GFE_POSTGRE_HOST
**Смысл**: Хост базы данных PostgreSQL  
**Тип**: Текстовое значение  
**Значение по умолчанию**: localhost  
**Пример**: 127.0.0.1  
<br>

#### 3.1.9. GFE_POSTGRE_PORT
**Смысл**: Порт базы данных PostgreSQL  
**Тип**: Целочисленный  
**Значение по умолчанию**: 5432  
**Пример**: 5433  
<br>

#### 3.1.10. GFE_POSTGRE_USER
**Смысл**: Пользователь базы данных PostgreSQL  
**Тип**: Текстовое значение  
**Значение по умолчанию**: отсутствует  
**Пример**: the_user  
<br>

#### 3.1.11. GFE_POSTGRE_PASSWORD
**Смысл**: Пароль базы данных PostgreSQL  
**Тип**: Текстовое значение  
**Значение по умолчанию**: отсутствует  
**Пример**: th3_p4s5w0rd  
<br>

#### 3.1.12. GFE_POSTGRE_DATABASE
**Смысл**: Название базы данных на сервере базы данных PostgreSQL  
**Тип**: Текстовое значение  
**Значение по умолчанию**: отсутствует  
**Пример**: the_database  
<br>

#### 3.1.13. GFE_POSTGRE_PARAMETERS
**Смысл**: Строка дополнительных параметров подключения, без символа '?'  
**Тип**: Текстовое значение  
**Значение по умолчанию**: отсутствует  
**Пример**: param1=value1&param2=value2  
<br>

#### 3.1.14. GFE_METRICS_HTTP_SERVER_HOST
**Смысл**: Хост HTTP сервера метрик  
**Тип**: Текстовое значение  
**Значение по умолчанию**: 0.0.0.0  
**Пример**: localhost  
<br>

#### 3.1.15. GFE_METRICS_HTTP_SERVER_PORT
**Смысл**: Порт HTTP сервера метрик  
**Тип**: Целочисленный  
**Значение по умолчанию**: отсутствует  
**Пример**: 9999  
<br>

#### 3.1.16. GFE_BUSINESS_HTTP_SERVER_HOST
**Смысл**: Хост HTTP сервера бизнес логики  
**Тип**: Текстовое значение  
**Значение по умолчанию**: 0.0.0.0  
**Пример**: localhost  
<br>

#### 3.1.17. GFE_BUSINESS_HTTP_SERVER_PORT
**Смысл**: Порт HTTP сервера бизнес логики  
**Тип**: Целочисленный  
**Значение по умолчанию**: отсутствует  
**Пример**: 8080  
<br>

[Вернуться назад ко списку содержимого](#contents_list)

## 4. HTTP запросы
<a id="section_4" name="section_4"></a>

### 4.1. Системные (внутренние)

Подробности можно посмотреть в OpenAPI документации 
[по ссылке](api/openapi/system/api.yaml).  

### 4.2. Основные рабочие (публичные)

Подробности можно посмотреть в OpenAPI документации 
[по ссылке](api/openapi/business/api.yaml).  

[Вернуться назад ко списку содержимого](#contents_list)

[//]: # (Коментарии)
[//]: # (Для совместимости с разными платформами в теге <a> нужно одновременно использовать свойства: 'id' для HTML5 
и 'name' для GitLab)
